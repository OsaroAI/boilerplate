#!/bin/bash
set -eo pipefail
. "$IMAGE_ROOT/lib.sh"

main() {
	local entrypoint="$(entrypoint-find "$1" || :)"
	if [[ -n "$entrypoint" ]]; then
		e "entrypoint: %s (resolved from %s)" "$entrypoint" "$1"

		# Replace first element with the full path to the entrypoint, keep the rest
		set -- "$entrypoint" "${@:2}"
	fi

	local prefix
	if pid_is_init && test -n "$*"; then
		# Use dumb-init by default on exec from init, but allow
		# it to be replaced.
		prefix="dumb-init --single-child"
	fi
	prefix="${ENTRYPOINT_EXEC_PREFIX:-$prefix}"
	debug "prefix: %s" "$prefix"

	entrypoint-hook "exec_$1" "exec"
	debug_call exec $prefix "$@"
}

main "$@"
