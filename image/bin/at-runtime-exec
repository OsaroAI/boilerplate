#!/bin/bash
set -eo pipefail
. "$IMAGE_ROOT/lib.sh"

runtimed="${RUNTIME_DEFERRED:?}"
mkdir -p "$runtimed"

stamp_started="${runtimed}/.started"
stamp_done="${runtimed}/.done"

if [[ $UID -ne 0 ]]; then
	warn "Not running as root, so not running at-runtime tasks from %s" "$runtimed"
	exit 0
fi

debug "Running any deferred at-runtime tasks from %s" "$runtimed"

touch "$stamp_started"

run-parts --verbose --exit-on-error "${runtimed}"

touch "$stamp_done"

debug "Done running deferred at runtime tasks from %s" "$runtimed"
